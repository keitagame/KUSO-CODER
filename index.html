<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>クソコードバトル</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Dots&family=Share+Tech+Mono&family=M+PLUS+1p:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#090910;--s1:#111118;--s2:#181824;--border:#252538;
  --red:#ff2d55;--cyan:#00e5cc;--yellow:#ffd60a;--blue:#0a84ff;
  --green:#30d158;--text:#dde0ff;--dim:#5a5a80;
}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);font-family:'M PLUS 1p',sans-serif;overflow:hidden}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:999;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,229,204,.012) 3px,rgba(0,229,204,.012) 4px)}

/* VIEWS */
.view{position:absolute;inset:0;display:none;flex-direction:column}
.view.active{display:flex}

/* TITLE */
#v-title{align-items:center;justify-content:center;gap:0;padding:1.5rem;overflow:hidden}
.title-bg{position:absolute;inset:0;background:radial-gradient(ellipse 60% 40% at 50% 30%,rgba(255,45,85,.08),transparent),radial-gradient(ellipse 40% 60% at 80% 70%,rgba(0,229,204,.05),transparent)}
.logo{position:relative;font-family:'Zen Dots',cursive;font-size:clamp(2.2rem,6vw,4.5rem);color:var(--red);text-shadow:0 0 30px rgba(255,45,85,.6),3px 2px 0 var(--cyan),-1px -1px 0 var(--yellow);animation:logoGlitch 4s infinite;letter-spacing:.04em;margin-bottom:.3rem}
@keyframes logoGlitch{0%,88%,100%{transform:none;filter:none}90%{transform:skew(-1.5deg);filter:hue-rotate(90deg)}92%{transform:skew(1deg) translateX(4px);filter:hue-rotate(-90deg)}94%{transform:none;filter:none}}
.logo-sub{font-family:'Share Tech Mono',monospace;font-size:.75rem;color:var(--cyan);letter-spacing:.35em;margin-bottom:2rem;opacity:.8}
.stats-row{display:flex;gap:2rem;margin-bottom:2rem;font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--dim)}
.stat{display:flex;flex-direction:column;align-items:center;gap:.2rem}
.stat b{font-size:1.5rem;color:var(--cyan);font-family:'Zen Dots',cursive}
.form-group{display:flex;flex-direction:column;gap:.8rem;width:100%;max-width:340px}
input.name-in{background:var(--s1);border:2px solid var(--border);color:var(--text);padding:.75rem 1rem;font-family:'Share Tech Mono',monospace;font-size:.95rem;outline:none;transition:border-color .2s;width:100%;clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px))}
input.name-in:focus{border-color:var(--cyan)}
.btn-main{background:var(--red);border:none;color:#fff;padding:.75rem;font-family:'Zen Dots',cursive;font-size:1rem;cursor:pointer;letter-spacing:.12em;transition:all .15s;clip-path:polygon(10px 0,100% 0,calc(100% - 10px) 100%,0 100%);font-weight:700}
.btn-main:hover{background:#ff5577;transform:scale(1.02)}
.how-to{position:relative;margin-top:1.5rem;max-width:360px;font-family:'Share Tech Mono',monospace;font-size:.72rem;color:var(--dim);line-height:1.9;text-align:center}

/* MATCHING */
#v-match{align-items:center;justify-content:center;gap:1.5rem}
.radar{width:160px;height:160px;border:2px solid var(--cyan);border-radius:50%;position:relative}
.radar::before{content:'';position:absolute;top:50%;left:50%;width:50%;height:2px;background:linear-gradient(90deg,var(--cyan),transparent);transform-origin:left center;animation:radarSpin 1.8s linear infinite}
.radar::after{content:'';position:absolute;inset:20%;border:1px solid rgba(0,229,204,.3);border-radius:50%}
@keyframes radarSpin{to{transform:rotate(360deg)}}
.match-label{font-family:'Zen Dots',cursive;font-size:1.1rem;color:var(--cyan);animation:blink 1s step-end infinite}
@keyframes blink{50%{opacity:0}}
.btn-ghost{background:transparent;border:1.5px solid var(--dim);color:var(--dim);padding:.6rem 1.8rem;font-family:'Zen Dots',cursive;font-size:.8rem;cursor:pointer;letter-spacing:.1em;transition:all .2s;clip-path:polygon(8px 0,100% 0,calc(100% - 8px) 100%,0 100%)}
.btn-ghost:hover{border-color:var(--text);color:var(--text)}

/* GAME */
#v-game{display:none;height:100vh;overflow:hidden}
#v-game.active{display:grid;grid-template-rows:auto auto 1fr;grid-template-columns:1fr}

/* timer strip */
.timer-strip{display:grid;grid-template-columns:1fr 60px 1fr;gap:6px;padding:8px 10px 0}
.t-bar-wrap{height:36px;position:relative;background:var(--s1);border:1px solid var(--border);overflow:hidden}
.t-bar-fill{position:absolute;top:0;bottom:0;left:0;transition:width .4s linear}
.t-bar-fill.mine{background:var(--red)}
.t-bar-fill.theirs{background:var(--blue)}
.t-bar-fill.danger{animation:dangerPulse .4s infinite alternate}
@keyframes dangerPulse{to{opacity:.5}}
.t-bar-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace;font-size:1rem;font-weight:700;text-shadow:0 0 8px rgba(0,0,0,.8)}
.t-vs{display:flex;align-items:center;justify-content:center;font-family:'Zen Dots',cursive;font-size:.75rem;color:var(--yellow)}

/* score strip */
.score-strip{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:4px 10px 6px;border-bottom:1px solid var(--border)}
.p-info{display:flex;align-items:center;gap:.5rem}
.p-info.opp{flex-direction:row-reverse}
.p-name{font-family:'Zen Dots',cursive;font-size:.65rem;letter-spacing:.05em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100px}
.p-score{font-family:'Zen Dots',cursive;font-size:1.8rem;line-height:1}
.p-info.me .p-score{color:var(--red);text-shadow:0 0 15px var(--red)}
.p-info.opp .p-score{color:var(--blue);text-shadow:0 0 15px var(--blue)}
.score-center{font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);text-align:center}

/* game body */
.game-body{display:grid;grid-template-columns:220px 1fr;overflow:hidden;min-height:0}

/* hand panel */
.hand-panel{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden}
.panel-hdr{padding:6px 10px;background:var(--s1);border-bottom:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);letter-spacing:.15em;display:flex;justify-content:space-between;align-items:center}
.panel-hdr span{color:var(--cyan)}
.hand-list{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px}
.hand-list::-webkit-scrollbar{width:3px}
.hand-list::-webkit-scrollbar-thumb{background:var(--border)}

/* card */
.card{background:var(--s1);border:1.5px solid var(--border);padding:8px 10px;cursor:pointer;transition:all .15s;position:relative;clip-path:polygon(0 0,calc(100% - 7px) 0,100% 7px,100% 100%,7px 100%,0 calc(100% - 7px))}
.card:hover{border-color:var(--yellow);background:var(--s2);transform:translateX(3px)}
.card.active-card{border-color:var(--cyan);background:rgba(0,229,204,.08)}
.card.active-card::before{content:'▶';position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--cyan);font-size:.7rem}
.card-title{font-family:'Zen Dots',cursive;font-size:.7rem;color:var(--yellow);margin-bottom:4px;padding-right:16px}
.card-meta{display:flex;justify-content:space-between;align-items:center}
.card-tags{display:flex;gap:3px;flex-wrap:wrap}
.tag{font-family:'Share Tech Mono',monospace;font-size:.55rem;padding:1px 5px;border:1px solid var(--border);color:var(--dim)}
.diff-pips{display:flex;gap:2px}
.pip{width:5px;height:5px;border-radius:50%;background:var(--border)}
.pip.on{background:var(--yellow)}
.empty-hand{padding:1rem;font-family:'Share Tech Mono',monospace;font-size:.7rem;color:var(--dim);text-align:center}

/* deck bar */
.deck-bar{padding:6px 10px;border-top:1px solid var(--border);background:var(--s1)}
.deck-pips{display:flex;gap:2px;flex-wrap:wrap}
.deck-pip{width:10px;height:14px;clip-path:polygon(0 0,calc(100% - 2px) 0,100% 2px,100% 100%,2px 100%,0 calc(100% - 2px))}
.deck-pip.on{background:rgba(255,45,85,.7)}
.deck-pip.off{background:var(--s2);border:1px solid var(--border)}

/* opp status */
.opp-status{padding:5px 10px;border-top:1px solid var(--border);font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--dim);display:flex;align-items:center;gap:6px}
.opp-dot{width:7px;height:7px;border-radius:50%;background:var(--dim);flex-shrink:0}
.opp-dot.solving{background:var(--blue);animation:solvingBlink .6s infinite alternate}
@keyframes solvingBlink{to{opacity:.3}}

/* code panel */
.code-panel{display:flex;flex-direction:column;overflow:hidden;min-height:0}
.code-header{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0}
.code-card-name{font-family:'Zen Dots',cursive;font-size:.72rem;color:var(--cyan)}
.hint-btn{background:none;border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:.6rem;padding:2px 8px;cursor:pointer;transition:all .15s;letter-spacing:.1em}
.hint-btn:hover{border-color:var(--yellow);color:var(--yellow)}
.code-display{flex:1;overflow:auto;background:#11121f;min-height:0}
.code-display::-webkit-scrollbar{width:4px;height:4px}
.code-display::-webkit-scrollbar-thumb{background:var(--border)}
.code-pre{padding:12px;margin:0;font-family:'Share Tech Mono',monospace;font-size:.88rem;line-height:1.65}
.no-code{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.5rem;font-family:'Share Tech Mono',monospace;font-size:.78rem;color:var(--dim);padding:1rem}
.arrow-left{font-size:1.5rem;color:var(--yellow);animation:arrowAnim 1.2s ease-in-out infinite}
@keyframes arrowAnim{0%,100%{transform:translateX(0)}50%{transform:translateX(-8px)}}
.hint-bar{padding:6px 10px;background:rgba(255,214,10,.06);border-top:1px dashed rgba(255,214,10,.25);font-family:'Share Tech Mono',monospace;font-size:.72rem;color:var(--yellow);display:none;flex-shrink:0}
.hint-bar.show{display:block}

/* answer strip */
.answer-strip{display:flex;gap:6px;padding:8px;border-top:1px solid var(--border);flex-shrink:0}
.answer-in{flex:1;background:var(--s1);border:1.5px solid var(--border);color:var(--text);padding:.6rem .8rem;font-family:'Share Tech Mono',monospace;font-size:.9rem;outline:none;transition:border-color .15s;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%)}
.answer-in:focus{border-color:var(--cyan)}
.answer-in:disabled{opacity:.35;cursor:not-allowed}
.submit-btn{background:var(--red);border:none;color:#fff;padding:.6rem 1.2rem;font-family:'Zen Dots',cursive;font-size:.8rem;cursor:pointer;letter-spacing:.08em;transition:all .15s;font-weight:700;clip-path:polygon(5px 0,100% 0,calc(100% - 5px) 100%,0 100%)}
.submit-btn:hover{background:#ff5070}
.submit-btn:disabled{opacity:.35;cursor:not-allowed}
.feedback-bar{padding:4px 10px;min-height:28px;font-family:'Share Tech Mono',monospace;font-size:.75rem;text-align:center;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.feedback-bar.ok{color:var(--green);background:rgba(48,209,88,.07)}
.feedback-bar.bad{color:var(--red);background:rgba(255,45,85,.07)}

/* RESULT */
#v-result{align-items:center;justify-content:center;gap:1.2rem;padding:2rem;text-align:center}
.result-big{font-family:'Zen Dots',cursive;font-size:clamp(3.5rem,12vw,7rem);animation:resultPop .4s cubic-bezier(.17,.67,.24,1.4)}
.result-big.win{color:var(--green);text-shadow:0 0 40px var(--green)}
.result-big.lose{color:var(--red);text-shadow:0 0 40px var(--red)}
@keyframes resultPop{0%{transform:scale(.4) rotate(-8deg);opacity:0}100%{transform:none;opacity:1}}
.result-reason{font-family:'Share Tech Mono',monospace;font-size:.85rem;color:var(--dim)}
.result-grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;width:100%;max-width:320px}
.result-cell{background:var(--s1);border:1px solid var(--border);padding:.8rem}
.result-cell-val{font-family:'Zen Dots',cursive;font-size:1.6rem;display:block;margin-bottom:.2rem}
.result-cell-lbl{font-family:'Share Tech Mono',monospace;font-size:.65rem;color:var(--dim)}

/* TOAST */
#toast{position:fixed;bottom:1.2rem;left:50%;transform:translateX(-50%) translateY(60px);background:var(--s2);border:1px solid var(--border);padding:.6rem 1.2rem;font-family:'Share Tech Mono',monospace;font-size:.8rem;z-index:1000;transition:transform .25s;white-space:nowrap;pointer-events:none}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.ok{border-color:var(--green);color:var(--green)}
#toast.err{border-color:var(--red);color:var(--red)}

/* conn */
#conn{position:fixed;top:.5rem;right:.8rem;z-index:100;font-family:'Share Tech Mono',monospace;font-size:.6rem;color:var(--dim);display:flex;align-items:center;gap:4px}
#conn-dot{width:6px;height:6px;border-radius:50%;background:var(--red)}
#conn-dot.on{background:var(--green)}
.hljs{background:transparent!important;padding:0!important}

@media(max-width:560px){
  .game-body{grid-template-columns:155px 1fr}
  .p-name{max-width:70px;font-size:.55rem}
}
</style>
</head>
<body>

<div id="conn"><div id="conn-dot"></div><span id="conn-txt">OFFLINE</span></div>

<!-- TITLE -->
<div id="v-title" class="view active">
  <div class="title-bg"></div>
  <div class="logo">クソコードバトル</div>
  <div class="logo-sub">// UGLY CODE SHOWDOWN //</div>
  <div class="stats-row">
    <div class="stat"><b id="s-wait">-</b>WAITING</div>
    <div class="stat"><b id="s-games">-</b>BATTLES</div>
    <div class="stat"><b id="s-online">-</b>ONLINE</div>
  </div>
  <div class="form-group">
    <input id="uname" class="name-in" type="text" placeholder="YOUR_USERNAME" maxlength="16" autocomplete="off">
    <button class="btn-main" onclick="startMatch()">⚔ BATTLE START</button>
  </div>
  <div class="how-to">
    <span style="color:var(--yellow)">// HOW TO PLAY //</span><br>
    ① 全世界マッチング&nbsp;&nbsp;② 手札からカードを出す<br>
    ③ コードの出力を当てる&nbsp;&nbsp;④ タイマーは<span style="color:var(--red)">常時</span>カウントダウン<br>
    ⑤ 先に0秒になった方が <span style="color:var(--red)">LOSE</span>
  </div>
</div>

<!-- MATCHING -->
<div id="v-match" class="view">
  <div class="radar"></div>
  <div class="match-label">SEARCHING FOR OPPONENT...</div>
  <div style="font-family:'Share Tech Mono',monospace;font-size:.75rem;color:var(--dim)">全世界マッチング中</div>
  <button class="btn-ghost" onclick="cancelMatch()">CANCEL</button>
</div>

<!-- GAME -->
<div id="v-game" class="view">
  <div class="timer-strip">
    <div class="t-bar-wrap">
      <div class="t-bar-fill mine" id="t-mine" style="width:100%"></div>
      <div class="t-bar-text" id="t-mine-txt">60.0s</div>
    </div>
    <div class="t-vs">VS</div>
    <div class="t-bar-wrap">
      <div class="t-bar-fill theirs" id="t-theirs" style="width:100%"></div>
      <div class="t-bar-text" id="t-theirs-txt">60.0s</div>
    </div>
  </div>
  <div class="score-strip">
    <div class="p-info me">
      <div class="p-score" id="my-score">0</div>
      <div>
        <div class="p-name" id="my-name" style="color:var(--red)">YOU</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:.55rem;color:var(--dim)">SOLVED</div>
      </div>
    </div>
    <div class="score-center" id="game-id-lbl">GAME #----</div>
    <div class="p-info opp">
      <div class="p-score" id="opp-score">0</div>
      <div>
        <div class="p-name" id="opp-name" style="color:var(--blue)">OPP</div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:.55rem;color:var(--dim)">SOLVED</div>
      </div>
    </div>
  </div>
  <div class="game-body">
    <div class="hand-panel">
      <div class="panel-hdr">HAND <span id="hand-cnt">0</span>/5</div>
      <div class="hand-list" id="hand-list"></div>
      <div class="deck-bar">
        <div style="font-family:'Share Tech Mono',monospace;font-size:.58rem;color:var(--dim);margin-bottom:4px">DECK: <span id="deck-cnt">0</span></div>
        <div class="deck-pips" id="deck-pips"></div>
      </div>
      <div class="opp-status">
        <div class="opp-dot" id="opp-dot"></div>
        <span id="opp-status">相手の状況待ち</span>
      </div>
    </div>
    <div class="code-panel">
      <div class="code-header">
        <div class="code-card-name" id="code-title">← カードを選んでください</div>
        <button class="hint-btn" id="hint-btn" onclick="toggleHint()" style="display:none">HINT</button>
      </div>
      <div class="code-display" id="code-display">
        <div class="no-code">
          <div class="arrow-left">←</div>
          <div>手札からカードを出して挑戦</div>
          <div style="font-size:.65rem;color:var(--dim);margin-top:.3rem">タイマーは常時カウントダウン中！</div>
        </div>
      </div>
      <div class="hint-bar" id="hint-bar"></div>
      <div class="answer-strip">
        <input class="answer-in" id="ans-in" placeholder="出力結果を入力... (Enter)" disabled autocomplete="off" onkeydown="if(event.key==='Enter')submitAns()">
        <button class="submit-btn" id="ans-btn" onclick="submitAns()" disabled>送信</button>
      </div>
      <div class="feedback-bar" id="feedback"></div>
    </div>
  </div>
</div>

<!-- RESULT -->
<div id="v-result" class="view">
  <div class="result-big" id="r-title">WIN!</div>
  <div class="result-reason" id="r-reason"></div>
  <div class="result-grid" id="r-grid"></div>
  <button class="btn-main" style="width:200px" onclick="goTitle()">PLAY AGAIN</button>
</div>

<div id="toast"></div>

<script>
let ws=null,gs=null,myName='',oppName='';
let timerInterval=null,hintOpen=false;
let myTime=60,oppTime=60;
const MAX_TIME=60;

function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('v-'+id).classList.add('active');
}

function connectWS(){
  const proto=location.protocol==='https:'?'wss:':'ws:';
  ws=new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen=()=>{setConn(true);fetchStats();setInterval(fetchStats,5000);setInterval(ping,5000)};
  ws.onclose=()=>{setConn(false);stopTimer();setTimeout(connectWS,3000)};
  ws.onerror=()=>setConn(false);
  ws.onmessage=e=>dispatch(JSON.parse(e.data));
}
function send(o){if(ws?.readyState===1)ws.send(JSON.stringify(o))}
function ping(){send({type:'ping'})}
function setConn(ok){
  document.getElementById('conn-dot').className=ok?'on':'';
  document.getElementById('conn-txt').textContent=ok?'ONLINE':'OFFLINE';
}

function dispatch(m){
  if(m.type==='pong')return;
  if(m.type==='waiting'){showView('match');return}
  if(m.type==='game_start'){onGameStart(m);return}
  if(m.type==='state_update'){applyState(m.state);return}
  if(m.type==='timer_update'){myTime=m.my_time;oppTime=m.opponent_time;renderTimers();return}
  if(m.type==='answer_result'){onAnswerResult(m);return}
  if(m.type==='game_over'){onGameOver(m);return}
  if(m.type==='error'){toast(m.message,'err');return}
}

function onGameStart(m){
  oppName=m.opponent_name;
  document.getElementById('game-id-lbl').textContent=`GAME #${m.game_id.slice(0,6).toUpperCase()}`;
  document.getElementById('my-name').textContent=myName;
  document.getElementById('opp-name').textContent=oppName;
  applyState(m.state);
  showView('game');
  startTimer();
  toast('マッチング成功！バトル開始！','ok');
}

function applyState(s){
  gs=s;
  myTime=s.me.time_left;oppTime=s.opponent.time_left;
  renderTimers();
  document.getElementById('my-score').textContent=s.me.score;
  document.getElementById('opp-score').textContent=s.opponent.score;
  document.getElementById('hand-cnt').textContent=s.me.hand_count;
  document.getElementById('deck-cnt').textContent=s.me.deck_count;
  renderHand(s.me.hand,s.me.current_code);
  renderDeckPips(s.me.deck_count);
  renderOppStatus(s.opponent);
  if(s.me.current_code){
    showCode(s.me.current_code);
    document.getElementById('ans-in').disabled=false;
    document.getElementById('ans-btn').disabled=false;
  }else{
    clearCode();
  }
  if(s.finished)stopTimer();
}

function renderTimers(){
  const mp=Math.max(0,(myTime/MAX_TIME)*100);
  const op=Math.max(0,(oppTime/MAX_TIME)*100);
  const mb=document.getElementById('t-mine');
  const ob=document.getElementById('t-theirs');
  mb.style.width=mp+'%';ob.style.width=op+'%';
  document.getElementById('t-mine-txt').textContent=myTime.toFixed(1)+'s';
  document.getElementById('t-theirs-txt').textContent=oppTime.toFixed(1)+'s';
  mb.className='t-bar-fill mine'+(myTime<12?' danger':'');
  ob.className='t-bar-fill theirs'+(oppTime<12?' danger':'');
}

function startTimer(){stopTimer();timerInterval=setInterval(()=>send({type:'tick'}),300)}
function stopTimer(){clearInterval(timerInterval);timerInterval=null}

function renderHand(hand,currentCard){
  const el=document.getElementById('hand-list');
  if(!hand?.length){el.innerHTML='<div class="empty-hand">手札がありません</div>';return}
  const curId=currentCard?.id||null;
  el.innerHTML=hand.map(c=>{
    if(!c)return'';
    const isCur=c.id===curId;
    const pips=Array.from({length:4},(_,i)=>`<div class="pip${i<c.difficulty?' on':''}"></div>`).join('');
    const tags=(c.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
    return`<div class="card${isCur?' active-card':''}" onclick="playCard('${c.id}')">
      <div class="card-title">${esc(c.title)}</div>
      <div class="card-meta"><div class="card-tags">${tags}</div><div class="diff-pips">${pips}</div></div>
    </div>`;
  }).join('');
}

function renderDeckPips(count){
  const total=count+(gs?.me?.hand_count||0);
  document.getElementById('deck-pips').innerHTML=
    Array.from({length:Math.min(total,14)},(_,i)=>
      `<div class="deck-pip ${i<count?'on':'off'}"></div>`).join('');
}

function renderOppStatus(opp){
  const dot=document.getElementById('opp-dot');
  const txt=document.getElementById('opp-status');
  if(opp.solving){dot.className='opp-dot solving';txt.textContent=`${oppName} が解読中...`;txt.style.color='var(--blue)'}
  else{dot.className='opp-dot';txt.textContent=`${oppName} がカードを選んでいます`;txt.style.color='var(--dim)'}
}

function showCode(card){
  if(!card)return;
  document.getElementById('code-title').textContent=`// ${card.title}`;
  document.getElementById('hint-btn').style.display='block';
  document.getElementById('hint-bar').textContent=card.hint||'';
  hintOpen=false;
  document.getElementById('hint-bar').classList.remove('show');
  document.getElementById('hint-btn').textContent='HINT';
  const display=document.getElementById('code-display');
  display.innerHTML=`<pre class="code-pre"><code class="language-python" id="code-el"></code></pre>`;
  document.getElementById('code-el').textContent=card.code;
  hljs.highlightElement(document.getElementById('code-el'));
}

function clearCode(){
  document.getElementById('code-display').innerHTML=`
    <div class="no-code">
      <div class="arrow-left">←</div>
      <div>手札からカードを出して挑戦</div>
      <div style="font-size:.65rem;color:var(--dim);margin-top:.3rem">タイマーは常時カウントダウン中！</div>
    </div>`;
  document.getElementById('code-title').textContent='← カードを選んでください';
  document.getElementById('hint-btn').style.display='none';
  document.getElementById('hint-bar').classList.remove('show');
  document.getElementById('ans-in').disabled=true;
  document.getElementById('ans-btn').disabled=true;
  document.getElementById('ans-in').value='';
  document.getElementById('feedback').textContent='';
  document.getElementById('feedback').className='feedback-bar';
}

function toggleHint(){
  hintOpen=!hintOpen;
  document.getElementById('hint-bar').classList.toggle('show',hintOpen);
  document.getElementById('hint-btn').textContent=hintOpen?'HIDE':'HINT';
}

function onAnswerResult(m){
  const fb=document.getElementById('feedback');
  if(m.correct){fb.textContent='✓ 正解！次のカードを選んでください';fb.className='feedback-bar ok';toast('正解！ +1 POINT','ok')}
  else{fb.textContent=m.message;fb.className='feedback-bar bad'}
}

function onGameOver(m){
  stopTimer();
  const win=m.is_winner;
  const r=document.getElementById('r-title');
  r.textContent=win?'WIN!':'LOSE...';
  r.className='result-big '+(win?'win':'lose');
  let reason='';
  if(m.reason==='opponent_disconnected')reason='相手が切断しました';
  else if(m.state?.me?.time_left<=0)reason='タイムアップ！';
  else if(m.state?.opponent?.time_left<=0)reason='相手のタイムアップ！';
  document.getElementById('r-reason').textContent=reason;
  if(m.state){
    const me=m.state.me,op=m.state.opponent;
    document.getElementById('r-grid').innerHTML=`
      <div class="result-cell"><span class="result-cell-val" style="color:var(--red)">${me.score}</span><span class="result-cell-lbl">自分の正解数</span></div>
      <div class="result-cell"><span class="result-cell-val" style="color:var(--blue)">${op.score}</span><span class="result-cell-lbl">相手の正解数</span></div>
      <div class="result-cell"><span class="result-cell-val">${me.time_left.toFixed(1)}s</span><span class="result-cell-lbl">残り時間</span></div>
      <div class="result-cell"><span class="result-cell-val">${me.solved_count}</span><span class="result-cell-lbl">解いた問題数</span></div>`;
  }
  showView('result');
}

function startMatch(){
  const v=document.getElementById('uname').value.trim();
  myName=v||'PLAYER_'+Math.floor(Math.random()*9999);
  document.getElementById('uname').value=myName;
  if(!ws||ws.readyState!==1){toast('接続中...','err');return}
  send({type:'find_match',username:myName});
}
function cancelMatch(){send({type:'cancel_match'});showView('title')}
function playCard(id){
  if(gs?.me?.current_code){toast('既に解読中です！','err');return}
  send({type:'play_card',card_id:id});
}
function submitAns(){
  const v=document.getElementById('ans-in').value.trim();
  if(!v)return;
  send({type:'submit_answer',answer:v});
  document.getElementById('ans-in').value='';
}
function goTitle(){showView('title');fetchStats()}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function toast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='show '+type;
  setTimeout(()=>{t.className=''},2800);
}
async function fetchStats(){
  try{const d=await(await fetch('/stats')).json();
    document.getElementById('s-wait').textContent=d.waiting;
    document.getElementById('s-games').textContent=d.active_games;
    document.getElementById('s-online').textContent=d.total_connections;
  }catch{}
}

connectWS();
document.getElementById('uname').addEventListener('keydown',e=>{if(e.key==='Enter')startMatch()});
</script>
</body>
</html>
